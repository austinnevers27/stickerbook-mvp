<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stickerbook â€“ Pick Your Background</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/stickerbook.css">
</head>
<body class="layout-contained">
  <div class="app-shell">
    <div class="phone-frame">
      <div class="phone-inner">
        <div class="shell-inner">
          <!-- Header -->
          <div class="top-row">
            <div class="logo-group" style="align-items: flex-start;">
              <div class="logo-mark">STICKERBOOK</div>
              <div class="logo-accent"></div>
            </div>
            <button class="btn-skip" id="skip-btn">Skip</button>
          </div>

          <h1 class="screen-title text-center">Pick your background</h1>

          <!-- Background picker section -->
          <div class="bg-picker-section">
            <!-- Pattern type tabs -->
            <div class="bg-tabs">
              <button class="bg-tab active" data-pattern="solid">Solid</button>
              <button class="bg-tab" data-pattern="stripes">Stripes</button>
              <button class="bg-tab" data-pattern="checkered">Checkered</button>
              <button class="bg-tab" data-pattern="dots">Dots</button>
            </div>

            <!-- Sub-filters (contextual) -->
            <div class="bg-subfilter hidden" id="stripes-filter">
              <button class="bg-subfilter-btn active" data-value="diagonal">Diagonal</button>
              <button class="bg-subfilter-btn" data-value="horizontal">Horizontal</button>
              <button class="bg-subfilter-btn" data-value="vertical">Vertical</button>
            </div>

            <div class="bg-subfilter hidden" id="checkered-filter">
              <button class="bg-subfilter-btn active" data-value="small">Small</button>
              <button class="bg-subfilter-btn" data-value="large">Large</button>
            </div>

            <div class="bg-subfilter hidden" id="dots-filter">
              <button class="bg-subfilter-btn active" data-value="small">Small</button>
              <button class="bg-subfilter-btn" data-value="large">Large</button>
            </div>

            <!-- Preview + Swatch Selector (for pattern modes) -->
            <div class="bg-preview-area hidden" id="preview-area">
              <div class="bg-preview-tile" id="preview-tile"></div>
              <div class="bg-swatch-row">
                <button class="bg-swatch active" id="swatch-base" data-target="base">
                  <div class="bg-swatch-color" id="swatch-base-color"></div>
                  <div class="bg-swatch-label">Base</div>
                </button>
                <button class="bg-swatch" id="swatch-pattern" data-target="pattern">
                  <div class="bg-swatch-color" id="swatch-pattern-color"></div>
                  <div class="bg-swatch-label" id="swatch-pattern-label">Pattern</div>
                </button>
              </div>
            </div>

            <!-- Scrollable color rows container -->
            <div class="bg-rows-container" id="bg-rows-container">
              <!-- JS injects Netflix-style rows here -->
            </div>
          </div>

          <!-- CTA -->
          <div class="cta-row">
            <button id="choose-stickers-btn" class="btn btn-primary" type="button" disabled>
              Choose stickers
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // === COLOR DATA ===
      const COLOR_FAMILIES = [
        {
          name: 'Neutrals',
          colors: [
            { name: 'White', hex: '#ffffff' },
            { name: 'Light Gray', hex: '#e5e7eb' },
            { name: 'Gray', hex: '#9ca3af' },
            { name: 'Dark Gray', hex: '#4b5563' },
            { name: 'Charcoal', hex: '#1f2937' },
            { name: 'Black', hex: '#030712' },
          ]
        },
        {
          name: 'Browns',
          colors: [
            { name: 'Cream', hex: '#fef3c7' },
            { name: 'Tan', hex: '#d4a574' },
            { name: 'Camel', hex: '#b8860b' },
            { name: 'Brown', hex: '#92400e' },
            { name: 'Chocolate', hex: '#6b3410' },
            { name: 'Espresso', hex: '#3d1f0d' },
          ]
        },
        {
          name: 'Reds',
          colors: [
            { name: 'Blush', hex: '#fecaca' },
            { name: 'Light Red', hex: '#f87171' },
            { name: 'Red', hex: '#ef4444' },
            { name: 'True Red', hex: '#dc2626' },
            { name: 'Dark Red', hex: '#b91c1c' },
            { name: 'Maroon', hex: '#7f1d1d' },
          ]
        },
        {
          name: 'Oranges',
          colors: [
            { name: 'Peach', hex: '#fed7aa' },
            { name: 'Light Orange', hex: '#fdba74' },
            { name: 'Orange', hex: '#fb923c' },
            { name: 'True Orange', hex: '#f97316' },
            { name: 'Dark Orange', hex: '#ea580c' },
            { name: 'Burnt Orange', hex: '#9a3412' },
          ]
        },
        {
          name: 'Yellows',
          colors: [
            { name: 'Lemon', hex: '#fef9c3' },
            { name: 'Light Yellow', hex: '#fef08a' },
            { name: 'Yellow', hex: '#facc15' },
            { name: 'Gold', hex: '#eab308' },
            { name: 'Dark Gold', hex: '#ca8a04' },
            { name: 'Mustard', hex: '#a16207' },
          ]
        },
        {
          name: 'Greens',
          colors: [
            { name: 'Mint', hex: '#bbf7d0' },
            { name: 'Light Green', hex: '#86efac' },
            { name: 'Green', hex: '#22c55e' },
            { name: 'True Green', hex: '#16a34a' },
            { name: 'Dark Green', hex: '#15803d' },
            { name: 'Forest', hex: '#14532d' },
          ]
        },
        {
          name: 'Blues',
          colors: [
            { name: 'Ice', hex: '#bfdbfe' },
            { name: 'Light Blue', hex: '#7dd3fc' },
            { name: 'Sky', hex: '#0ea5e9' },
            { name: 'Blue', hex: '#3b82f6' },
            { name: 'Dark Blue', hex: '#1d4ed8' },
            { name: 'Navy', hex: '#1e3a8a' },
          ]
        },
        {
          name: 'Purples',
          colors: [
            { name: 'Lavender', hex: '#e9d5ff' },
            { name: 'Light Purple', hex: '#d8b4fe' },
            { name: 'Purple', hex: '#a855f7' },
            { name: 'True Purple', hex: '#9333ea' },
            { name: 'Dark Purple', hex: '#7e22ce' },
            { name: 'Deep Purple', hex: '#581c87' },
          ]
        },
        {
          name: 'Pinks',
          colors: [
            { name: 'Pale Pink', hex: '#fce7f3' },
            { name: 'Light Pink', hex: '#f9a8d4' },
            { name: 'Pink', hex: '#f472b6' },
            { name: 'Hot Pink', hex: '#ec4899' },
            { name: 'Dark Pink', hex: '#db2777' },
            { name: 'Magenta', hex: '#a21caf' },
          ]
        }
      ];

      // === STATE ===
      let currentPattern = 'solid';
      let currentSubfilter = {
        stripes: 'diagonal',
        checkered: 'small',
        dots: 'small'
      };
      let selectedBaseColor = null;
      let selectedPatternColor = null;
      let editingTarget = 'base'; // 'base' or 'pattern'

      // === DOM ===
      const tabs = document.querySelectorAll('.bg-tab');
      const stripesFilter = document.getElementById('stripes-filter');
      const checkeredFilter = document.getElementById('checkered-filter');
      const dotsFilter = document.getElementById('dots-filter');
      const previewArea = document.getElementById('preview-area');
      const previewTile = document.getElementById('preview-tile');
      const swatchBase = document.getElementById('swatch-base');
      const swatchPattern = document.getElementById('swatch-pattern');
      const swatchBaseColor = document.getElementById('swatch-base-color');
      const swatchPatternColor = document.getElementById('swatch-pattern-color');
      const swatchPatternLabel = document.getElementById('swatch-pattern-label');
      const rowsContainer = document.getElementById('bg-rows-container');
      const chooseBtn = document.getElementById('choose-stickers-btn');
      const skipBtn = document.getElementById('skip-btn');

      // === PATTERN GENERATORS ===
      function getPatternCSS(pattern, subfilter, baseHex, patternHex) {
        // Default colors if not set
        const base = baseHex || '#e5e7eb';
        const pat = patternHex || '#ffffff';

        switch (pattern) {
          case 'solid':
            return `background-color: ${base};`;

          case 'stripes':
            const stripeSize = '10px';
            if (subfilter === 'diagonal') {
              return `background: repeating-linear-gradient(135deg, ${base}, ${base} ${stripeSize}, ${pat} ${stripeSize}, ${pat} calc(${stripeSize} * 2));`;
            } else if (subfilter === 'horizontal') {
              return `background: repeating-linear-gradient(0deg, ${base}, ${base} ${stripeSize}, ${pat} ${stripeSize}, ${pat} calc(${stripeSize} * 2));`;
            } else if (subfilter === 'vertical') {
              return `background: repeating-linear-gradient(90deg, ${base}, ${base} ${stripeSize}, ${pat} ${stripeSize}, ${pat} calc(${stripeSize} * 2));`;
            }
            break;

          case 'checkered':
            const checkSize = subfilter === 'small' ? '16px' : '24px';
            return `
              background-color: ${base};
              background-image:
                linear-gradient(45deg, ${pat} 25%, transparent 25%),
                linear-gradient(-45deg, ${pat} 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, ${pat} 75%),
                linear-gradient(-45deg, transparent 75%, ${pat} 75%);
              background-size: ${checkSize} ${checkSize};
              background-position: 0 0, 0 calc(${checkSize}/2), calc(${checkSize}/2) calc(-${checkSize}/2), calc(-${checkSize}/2) 0;
            `;

          case 'dots':
            let dotSize, gap;
            if (subfilter === 'small') {
              dotSize = '6px';
              gap = '16px';
            } else {
              dotSize = '10px';
              gap = '24px';
            }
            return `background-color: ${base}; background-image: radial-gradient(${pat} ${dotSize}, transparent ${dotSize}); background-size: ${gap} ${gap};`;
        }

        return `background-color: ${base};`;
      }

      // === UPDATE PREVIEW ===
      function updatePreview() {
        if (currentPattern === 'solid') {
          previewArea.classList.add('hidden');
          return;
        }

        previewArea.classList.remove('hidden');

        // Update pattern label
        if (currentPattern === 'stripes') {
          swatchPatternLabel.textContent = 'Stripe';
        } else if (currentPattern === 'checkered') {
          swatchPatternLabel.textContent = 'Check';
        } else if (currentPattern === 'dots') {
          swatchPatternLabel.textContent = 'Dot';
        }

        // Update swatch colors
        swatchBaseColor.style.backgroundColor = selectedBaseColor || '#e5e7eb';
        swatchPatternColor.style.backgroundColor = selectedPatternColor || '#ffffff';

        // Update preview tile
        const subfilter = currentSubfilter[currentPattern];
        previewTile.style.cssText = getPatternCSS(currentPattern, subfilter, selectedBaseColor, selectedPatternColor);

        // Update active swatch
        swatchBase.classList.toggle('active', editingTarget === 'base');
        swatchPattern.classList.toggle('active', editingTarget === 'pattern');
      }

      // === CHECK BUTTON STATE ===
      function updateButtonState() {
        if (currentPattern === 'solid') {
          chooseBtn.disabled = !selectedBaseColor;
        } else {
          chooseBtn.disabled = !(selectedBaseColor && selectedPatternColor);
        }
      }

      // === RENDER COLOR ROWS ===
      function renderColorRows() {
        rowsContainer.innerHTML = '';

        COLOR_FAMILIES.forEach(family => {
          const section = document.createElement('section');
          section.className = 'bg-row-section';

          const header = document.createElement('div');
          header.className = 'bg-row-header';
          header.textContent = family.name;
          section.appendChild(header);

          const strip = document.createElement('div');
          strip.className = 'bg-row-strip';

          family.colors.forEach(color => {
            const tile = document.createElement('div');
            tile.className = 'bg-tile-new';
            tile.dataset.hex = color.hex;

            const inner = document.createElement('div');
            inner.className = 'bg-tile-new-inner';

            // Show appropriate preview
            if (currentPattern === 'solid') {
              inner.style.cssText = `background-color: ${color.hex};`;
              if (selectedBaseColor === color.hex) {
                tile.classList.add('selected');
              }
            } else {
              // For pattern modes, show what it would look like
              if (editingTarget === 'base') {
                // Show solid color for base selection
                inner.style.cssText = `background-color: ${color.hex};`;
                if (selectedBaseColor === color.hex) {
                  tile.classList.add('selected');
                }
              } else {
                // Show pattern preview for pattern color selection
                const subfilter = currentSubfilter[currentPattern];
                inner.style.cssText = getPatternCSS(currentPattern, subfilter, selectedBaseColor || '#e5e7eb', color.hex);
                if (selectedPatternColor === color.hex) {
                  tile.classList.add('selected');
                }
              }
            }

            tile.appendChild(inner);
            tile.addEventListener('click', () => handleColorClick(color.hex));
            strip.appendChild(tile);
          });

          section.appendChild(strip);
          rowsContainer.appendChild(section);
        });
      }

      // === HANDLE COLOR CLICK ===
      function handleColorClick(hex) {
        if (currentPattern === 'solid') {
          selectedBaseColor = hex;
        } else {
          if (editingTarget === 'base') {
            selectedBaseColor = hex;
            // Auto-switch to pattern selection after picking base
            editingTarget = 'pattern';
          } else {
            selectedPatternColor = hex;
          }
        }

        render();
      }

      // === MAIN RENDER ===
      function render() {
        updatePreview();
        renderColorRows();
        updateButtonState();
      }

      // === TAB SWITCHING ===
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const newPattern = tab.dataset.pattern;

          // Reset state when switching patterns
          if (newPattern !== currentPattern) {
            selectedPatternColor = null;
            editingTarget = 'base';
          }

          currentPattern = newPattern;

          // Show/hide subfilters
          stripesFilter.classList.add('hidden');
          checkeredFilter.classList.add('hidden');
          dotsFilter.classList.add('hidden');

          if (currentPattern === 'stripes') {
            stripesFilter.classList.remove('hidden');
          } else if (currentPattern === 'checkered') {
            checkeredFilter.classList.remove('hidden');
          } else if (currentPattern === 'dots') {
            dotsFilter.classList.remove('hidden');
          }

          render();
        });
      });

      // === SUBFILTER SWITCHING ===
      stripesFilter.querySelectorAll('.bg-subfilter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          stripesFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSubfilter.stripes = btn.dataset.value;
          render();
        });
      });

      checkeredFilter.querySelectorAll('.bg-subfilter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          checkeredFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSubfilter.checkered = btn.dataset.value;
          render();
        });
      });

      dotsFilter.querySelectorAll('.bg-subfilter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          dotsFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSubfilter.dots = btn.dataset.value;
          render();
        });
      });

      // === SWATCH CLICK ===
      swatchBase.addEventListener('click', () => {
        editingTarget = 'base';
        render();
      });

      swatchPattern.addEventListener('click', () => {
        editingTarget = 'pattern';
        render();
      });

      // === SAVE & CONTINUE ===
      chooseBtn.addEventListener('click', () => {
        if (!selectedBaseColor) return;
        if (currentPattern !== 'solid' && !selectedPatternColor) return;

        const subfilter = currentSubfilter[currentPattern] || '';

        // Build the final CSS
        const finalCSS = getPatternCSS(currentPattern, subfilter, selectedBaseColor, selectedPatternColor);

        // Build data object
        const backgroundData = {
          pattern: currentPattern,
          subfilter: subfilter,
          baseColor: selectedBaseColor,
          patternColor: selectedPatternColor || null
        };

        // Store selection
        localStorage.setItem('current_page_index', '1');
        localStorage.setItem('current_page_background', selectedBaseColor);
        localStorage.setItem('stickerbook_page_1_background', selectedBaseColor);
        localStorage.setItem('stickerbook_page_1_background_css', finalCSS);
        localStorage.setItem('stickerbook_page_1_background_data', JSON.stringify(backgroundData));

        window.location.href = 'sticker-selection.html';
      });

      // === SKIP (dev tool) ===
      skipBtn.addEventListener('click', () => {
        window.location.href = 'sticker-selection.html';
      });

      // === LOAD SAVED STATE ===
      function loadSavedState() {
        try {
          const saved = localStorage.getItem('stickerbook_page_1_background_data');
          if (saved) {
            const data = JSON.parse(saved);

            currentPattern = data.pattern || 'solid';
            selectedBaseColor = data.baseColor || null;
            selectedPatternColor = data.patternColor || null;

            if (data.subfilter) {
              if (currentPattern === 'stripes') {
                currentSubfilter.stripes = data.subfilter;
              } else if (currentPattern === 'checkered') {
                currentSubfilter.checkered = data.subfilter;
              } else if (currentPattern === 'dots') {
                currentSubfilter.dots = data.subfilter;
              }
            }

            // Set tab
            tabs.forEach(t => {
              t.classList.toggle('active', t.dataset.pattern === currentPattern);
            });

            // Set subfilter buttons
            if (currentPattern === 'stripes') {
              stripesFilter.classList.remove('hidden');
              stripesFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.value === currentSubfilter.stripes);
              });
            } else if (currentPattern === 'checkered') {
              checkeredFilter.classList.remove('hidden');
              checkeredFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.value === currentSubfilter.checkered);
              });
            } else if (currentPattern === 'dots') {
              dotsFilter.classList.remove('hidden');
              dotsFilter.querySelectorAll('.bg-subfilter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.value === currentSubfilter.dots);
              });
            }

            // Set editing target based on what's selected
            if (currentPattern !== 'solid' && selectedBaseColor && !selectedPatternColor) {
              editingTarget = 'pattern';
            }
          }
        } catch (e) {
          // Ignore parse errors
        }
      }

      // === INIT ===
      loadSavedState();
      render();
    })();
  </script>
</body>
</html>