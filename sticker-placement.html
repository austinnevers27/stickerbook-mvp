<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stickerbook â€“ Arrange Your Stickers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Hammer.js for touch gestures -->
  <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>

  <style>
    :root {
      --bg-pink: #ffeef7;
      --bg-blue: #e7f9ff;

      --shell-bg: #ffffff;
      --shell-border: rgba(148, 163, 184, 0.12);
      --shell-shadow-main: 0 18px 40px rgba(15, 23, 42, 0.20);

      --text-main: #111827;
      --text-muted: #6b7280;
      --text-subtle: #9ca3af;

      --button-gradient: linear-gradient(135deg, #ff4f96, #ff7a4e, #22d3ee);
      --button-text: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at top left, var(--bg-pink) 0, #ffffff 45%),
        radial-gradient(circle at bottom right, var(--bg-blue) 0, #ffffff 45%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
      color: var(--text-main);
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 420px;
      display: flex;
      justify-content: center;
    }

    .phone-frame {
      width: 100%;
      max-width: 380px;
      background: var(--shell-bg);
      border-radius: 32px;
      padding: 24px 18px 24px;
      box-shadow:
        var(--shell-shadow-main),
        0 0 0 1px var(--shell-border);
      display: flex;
      flex-direction: column;
      align-items: center;

      height: 700px;
      max-height: calc(100vh - 80px);
      overflow: hidden;
    }

    .phone-notch {
      width: 80px;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .phone-inner {
      width: 100%;
      border-radius: 26px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      /* background color will be set from JS to chosen page background */
      background: #ffffff;
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      overflow: hidden;
    }

    .shell-inner {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      height: 100%;
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .logo-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .logo-mark {
      font-family: "Poppins", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.20em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .logo-accent {
      width: 80px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, #ff4f96, #ff7a4e, #22d3ee);
    }

    .screen-title {
      font-family: "Poppins", system-ui, sans-serif;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin: 6px 0 4px;
      color: var(--text-main);
      text-align: center;
      flex-shrink: 0;
    }

    .screen-subtitle {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-muted);
      margin: 0 0 8px;
      text-align: center;
      flex-shrink: 0;
    }

    .placement-section {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      margin-top: 6px;
    }

    /* This region is where stickers are allowed; background bleeds behind it */
    .sticker-region {
      flex: 1;
      min-height: 0;
      border-radius: 22px;
      overflow: hidden;
      position: relative;
      margin: 4px 0 10px;
    }

    #stickerCanvas {
      position: relative;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* Sticker elements */
    .sticker {
      position: absolute;
      touch-action: none;
      user-select: none;
      transform-origin: center center;
      cursor: grab;
    }

    .sticker img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      display: block;
    }

    .sticker.selected {
      outline: 2px solid rgba(14, 165, 233, 0.8);
      border-radius: 16px;
    }

    .sticker-delete {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    .sticker.selected .sticker-delete {
      opacity: 1;
      pointer-events: auto;
    }

    .placement-tip {
      font-size: 11px;
      color: var(--text-subtle);
      text-align: center;
      margin-bottom: 6px;
      min-height: 14px;
    }

    .footer-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 9px 20px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      background: var(--button-gradient);
      color: var(--button-text);
      box-shadow:
        0 12px 22px rgba(236, 72, 153, 0.35),
        0 0 0 1px rgba(248, 250, 252, 0.5);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      white-space: nowrap;
      transition:
        background 0.18s ease,
        transform 0.15s ease,
        box-shadow 0.18s ease,
        opacity 0.18s ease;
    }

    .btn-primary:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      box-shadow:
        0 0 0 1px rgba(209, 213, 219, 0.8);
      background: linear-gradient(135deg, #f9fafb, #e5e7eb);
      color: #9ca3af;
    }

    .btn-primary:not(:disabled):active {
      transform: translateY(1px) scale(0.99);
      box-shadow:
        0 6px 12px rgba(236, 72, 153, 0.30);
    }

    @media (max-width: 480px) {
      .phone-frame {
        height: 640px;
        max-height: calc(100vh - 48px);
        padding: 20px 14px 20px;
      }

      .phone-inner {
        padding: 14px 12px 12px;
      }

      .screen-title {
        font-size: 16px;
      }

      .screen-subtitle {
        font-size: 11px;
      }

      .btn-primary {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="phone-frame">
      <div class="phone-notch"></div>

      <div class="phone-inner" id="phone-inner">
        <div class="shell-inner">
          <!-- Logo -->
          <div class="top-row">
            <div class="logo-group">
              <div class="logo-mark">STICKERBOOK</div>
              <div class="logo-accent"></div>
            </div>
          </div>

          <!-- Title -->
          <h1 class="screen-title">Arrange your stickers</h1>
          <p class="screen-subtitle">
            Drag, resize, and rotate to design this page.
          </p>

          <div class="placement-section">
            <!-- Main sticker area -->
            <div class="sticker-region">
              <div id="stickerCanvas"></div>
            </div>

            <div class="placement-tip" id="placement-tip">
              Tip: pinch with two fingers to resize and twist to rotate.
            </div>

            <!-- Footer -->
            <div class="footer-row">
              <button id="continue-button" class="btn-primary">
                Continue
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- STATE -----
    const phoneInnerEl = document.getElementById("phone-inner");
    const stickerCanvas = document.getElementById("stickerCanvas");
    const continueButtonEl = document.getElementById("continue-button");
    const placementTipEl = document.getElementById("placement-tip");

    let pageData = null;
    let currentZ = 10;
    let selectedStickerEl = null;

    // ----- LOAD PAGE DATA -----
    function loadPageData() {
      // Primary: stickerbook_page_1
      const directRaw = localStorage.getItem("stickerbook_page_1");
      if (directRaw) {
        try {
          pageData = JSON.parse(directRaw);
        } catch {
          pageData = null;
        }
      }

      // Fallback: stickerbook_pages.page_1
      if (!pageData) {
        try {
          const pagesRaw = localStorage.getItem("stickerbook_pages");
          if (pagesRaw) {
            const pages = JSON.parse(pagesRaw);
            if (pages && pages.page_1) {
              pageData = pages.page_1;
            }
          }
        } catch {
          pageData = null;
        }
      }

      // Fallback: background + no stickers
      if (!pageData) {
        const bg =
          localStorage.getItem("stickerbook_page_1_background") ||
          localStorage.getItem("current_page_background") ||
          "#ffffff";
        pageData = {
          background: bg,
          stickers: []
        };
      }

      // Normalize stickers structure
      if (!Array.isArray(pageData.stickers)) {
        pageData.stickers = [];
      }

      // If we only have id + src from selection, make sure fields exist
      pageData.stickers = pageData.stickers.map((s, index) => ({
        id: s.id,
        src: s.src || s.image || "",
        x: typeof s.x === "number" ? s.x : null,
        y: typeof s.y === "number" ? s.y : null,
        scale: typeof s.scale === "number" ? s.scale : 1,
        rotation: typeof s.rotation === "number" ? s.rotation : 0,
        zIndex: typeof s.zIndex === "number" ? s.zIndex : (10 + index)
      }));
    }

    function applyBackground() {
      const bg = pageData.background || "#ffffff";
      phoneInnerEl.style.backgroundColor = bg;
      // Also apply to canvas so it shows inside rounded sticker-region
      stickerCanvas.style.backgroundColor = bg;
    }

    // ----- STICKER CREATION -----
    function createStickerElement(stObj, index) {
      const el = document.createElement("div");
      el.className = "sticker";

      // Basic size (can tweak)
      const baseSize = 110;
      el.style.width = baseSize + "px";

      // Default positions if not yet placed
      let x = (typeof stObj.x === "number") ? stObj.x : null;
      let y = (typeof stObj.y === "number") ? stObj.y : null;

      if (x === null || y === null) {
        // Simple grid-ish layout
        const col = index % 3;
        const row = Math.floor(index / 3);
        x = 40 + col * 80;
        y = 40 + row * 90;
      }

      const scale = (typeof stObj.scale === "number") ? stObj.scale : 1;
      const rotation = (typeof stObj.rotation === "number") ? stObj.rotation : 0;

      el.dataset.id = stObj.id;
      el.dataset.x = x;
      el.dataset.y = y;
      el.dataset.scale = scale;
      el.dataset.rotation = rotation;

      el.style.left = x + "px";
      el.style.top = y + "px";
      el.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
      el.style.zIndex = stObj.zIndex || ++currentZ;

      const img = document.createElement("img");
      img.src = stObj.src || "";
      img.alt = "";
      el.appendChild(img);

      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "sticker-delete";
      deleteBtn.textContent = "ðŸ—‘";
      el.appendChild(deleteBtn);

      // Select on tap/click
      el.addEventListener("click", (e) => {
        // ignore if clicking the delete button (its handler will run)
        if (e.target === deleteBtn) return;
        setSelectedSticker(el);
      });

      // Delete handler
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteSticker(el);
      });

      attachGestureHandlers(el);

      return el;
    }

    function setSelectedSticker(el) {
      if (selectedStickerEl === el) return;
      if (selectedStickerEl) {
        selectedStickerEl.classList.remove("selected");
      }
      selectedStickerEl = el;
      if (selectedStickerEl) {
        selectedStickerEl.classList.add("selected");
      }
    }

    function deleteSticker(el) {
      const id = el.dataset.id;
      el.remove();
      if (selectedStickerEl === el) {
        selectedStickerEl = null;
      }

      // Also remove from pageData
      pageData.stickers = pageData.stickers.filter((s) => s.id !== id);
      savePageData();

      if (pageData.stickers.length === 0) {
        placementTipEl.textContent = "You removed all stickers. Go back to add more if needed.";
      }
    }

    // ----- GESTURES -----
    function attachGestureHandlers(el) {
      const hammer = new Hammer.Manager(el);
      const pan = new Hammer.Pan({ threshold: 0 });
      const pinch = new Hammer.Pinch({ threshold: 0 });
      const rotate = new Hammer.Rotate({ threshold: 0 });

      pinch.recognizeWith(rotate);
      hammer.add([pan, pinch, rotate]);

      let startX = 0, startY = 0;
      let startScale = 1, startRotation = 0;
      let canvasWidth = 0, canvasHeight = 0;
      let elWidth = 0, elHeight = 0;

      hammer.on("panstart", () => {
        el.style.zIndex = ++currentZ;
        setSelectedSticker(el);

        startX = parseFloat(el.dataset.x) || 0;
        startY = parseFloat(el.dataset.y) || 0;

        canvasWidth = stickerCanvas.clientWidth;
        canvasHeight = stickerCanvas.clientHeight;
        elWidth = el.offsetWidth;
        elHeight = el.offsetHeight;
      });

      hammer.on("panmove", (ev) => {
        let newX = startX + ev.deltaX;
        let newY = startY + ev.deltaY;

        // Clamp within canvas bounds (keeps stickers out of header/footer)
        const maxX = Math.max(canvasWidth - elWidth, 0);
        const maxY = Math.max(canvasHeight - elHeight, 0);

        newX = Math.min(Math.max(newX, 0), maxX);
        newY = Math.min(Math.max(newY, 0), maxY);

        el.dataset.x = newX;
        el.dataset.y = newY;
        el.style.left = newX + "px";
        el.style.top = newY + "px";
      });

      hammer.on("pinchstart rotatestart", () => {
        startScale = parseFloat(el.dataset.scale) || 1;
        startRotation = parseFloat(el.dataset.rotation) || 0;
      });

      hammer.on("pinchmove rotatemove", (ev) => {
        let scale = startScale * ev.scale;
        let rotation = startRotation + ev.rotation;

        // Clamp scale
        if (scale < 0.35) scale = 0.35;
        if (scale > 3.2) scale = 3.2;

        el.dataset.scale = scale;
        el.dataset.rotation = rotation;
        el.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
      });
    }

    // ----- RENDER / SAVE -----
    function renderStickers() {
      stickerCanvas.innerHTML = "";
      if (!pageData.stickers || pageData.stickers.length === 0) {
        placementTipEl.textContent =
          "No stickers yet. Go back and choose stickers to design this page.";
        return;
      }

      placementTipEl.textContent =
        "Tip: pinch with two fingers to resize and twist to rotate.";

      pageData.stickers.forEach((s, index) => {
        const el = createStickerElement(s, index);
        stickerCanvas.appendChild(el);
      });
    }

    function savePageData() {
      // Pull latest positions from DOM
      const stickerEls = Array.from(stickerCanvas.querySelectorAll(".sticker"));
      pageData.stickers = stickerEls.map((el, index) => ({
        id: el.dataset.id,
        src: (pageData.stickers.find((s) => s.id === el.dataset.id) || {}).src || "",
        x: parseFloat(el.dataset.x) || 0,
        y: parseFloat(el.dataset.y) || 0,
        scale: parseFloat(el.dataset.scale) || 1,
        rotation: parseFloat(el.dataset.rotation) || 0,
        zIndex: parseInt(el.style.zIndex || (10 + index), 10)
      }));

      // Save background as well
      const bg =
        phoneInnerEl.style.backgroundColor ||
        pageData.background ||
        "#ffffff";
      pageData.background = bg;

      // Save both canonical keys
      localStorage.setItem("stickerbook_page_1", JSON.stringify(pageData));

      try {
        const pagesRaw = localStorage.getItem("stickerbook_pages") || "{}";
        const pages = JSON.parse(pagesRaw);
        pages.page_1 = pageData;
        localStorage.setItem("stickerbook_pages", JSON.stringify(pages));
      } catch {
        localStorage.setItem(
          "stickerbook_pages",
          JSON.stringify({ page_1: pageData })
        );
      }
    }

    // ----- EVENTS -----
    continueButtonEl.addEventListener("click", () => {
      savePageData();
      // TODO: point this to whatever the next real page is
      // For now we'll just send back to intro.
      window.location.href = "intro.html";
    });

    window.addEventListener("beforeunload", () => {
      savePageData();
    });

    // ----- INIT -----
    function init() {
      loadPageData();
      applyBackground();
      renderStickers();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
